workflows:
  ios-app-store:
    name: Upload build to ASC ‚Äî deep debug

    integrations:
      app_store_connect: "CodeMagic API"

    environment:
      xcode: 16.3
      groups: [appstore_credentials]          # —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã
      vars:
        XCODE_PROJECT: "HiddenCameraDetector.xcodeproj"
        XCODE_SCHEME:  "HiddenCameraDetector"

    scripts:
      # 0Ô∏è‚É£ –ü–µ—á–∞—Ç–∞–µ–º –±–∞–∑–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      - name: üîé Env
        script: |
          echo "macOS   $(sw_vers -productVersion)"
          echo "Xcode   $(xcodebuild -version | head -1)"
          echo "Project $XCODE_PROJECT  Scheme $XCODE_SCHEME"

      # 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ç—è–Ω—É–ª–∏—Å—å –ª–∏ —Å–µ–∫—Ä–µ—Ç—ã
      - name: üîé Check env secrets (masked)
        script: |
          check_var () {
            local name="$1" ; local v="${!name}"
            if [ -z "$v" ]; then
              echo "‚ùå  $name is EMPTY"
            else
              echo "‚úÖ  $name length=${#v} head=${v:0:4}‚Ä¶ tail=‚Ä¶${v: -4}"
              echo "$v" | shasum -a 256 | awk '{print "    sha256="$1}'
            fi
          }

          check_var APP_STORE_CONNECT_PRIVATE_KEY
          check_var APP_STORE_CONNECT_KEY_ID
          check_var APP_STORE_CONNECT_ISSUER_ID
          check_var CERT_PASSWORD

      # 2Ô∏è‚É£ –°–ø–∏—Å–æ–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
      - name: üîé Certificates
        script: |
          keychain list-certificates || true
          security find-identity -v -p codesigning || true

      # 3Ô∏è‚É£ –°–ø–∏—Å–æ–∫ provisioning profiles
      - name: üîé Profiles
        script: |
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "Profiles at $PROFILE_DIR:"
          ls -l "$PROFILE_DIR" || true

      # 4Ô∏è‚É£ Build settings —Ç–∞—Ä–≥–µ—Ç–∞
      - name: üîé Build settings
        script: |
          xcodebuild -project "$XCODE_PROJECT" \
                     -scheme  "$XCODE_SCHEME" \
                     -showBuildSettings \
            | egrep "PRODUCT_BUNDLE_IDENTIFIER|CODE_SIGN_STYLE|DEVELOPMENT_TEAM"

      # 5Ô∏è‚É£ Archive + Export
      - name: Archive & export
        script: |
          set -e
          xcodebuild -project "$XCODE_PROJECT" \
                     -scheme  "$XCODE_SCHEME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -allowProvisioningUpdates \
                     clean archive

          APP_PATH="$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive/Products/Applications/$XCODE_SCHEME.app"
          if [[ -f "$APP_PATH/embedded.mobileprovision" ]]; then
            echo "embedded.mobileprovision present ‚úÖ"
          else
            echo "embedded.mobileprovision missing ‚ö†Ô∏è"
          fi

          xcodebuild -exportArchive \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -exportOptionsPlist ExportOptions.plist \
                     -allowProvisioningUpdates \
                     -exportPath "$CM_EXPORT_DIR"

    artifacts:
      - "$CM_EXPORT_DIR/*.ipa"

    publishing:
      app_store_connect:
        api_key:            $APP_STORE_CONNECT_PRIVATE_KEY
        key_id:             $APP_STORE_CONNECT_KEY_ID
        issuer_id:          $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: false
        submit_to_app_store:  false

code_signing:
  certificates:
    - certificate: Hidden          # reference-name p12 –≤ UI
      password:   $CERT_PASSWORD   # –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –≥—Ä—É–ø–ø–µ appstore_credentials
  provisioning_profiles:
    - profile: HiddenProfile       # reference-name .mobileprovision –≤ UI
      bundle_id: dev.legacy.HiddenCameraDetector
