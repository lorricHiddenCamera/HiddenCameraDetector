workflows:
  ios-app-store:
    name: Upload build to ASC (debug)

    integrations:
      app_store_connect: "CodeMagic API"

    environment:
      xcode: 16.3
      groups: [appstore_credentials]              # API‚Äëkey + CERT_PASSWORD
      vars:
        XCODE_PROJECT: "HiddenCameraDetector.xcodeproj"
        XCODE_SCHEME:  "HiddenCameraDetector"

    scripts:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 0.  –ü–µ—á–∞—Ç–∞–µ–º –±–∞–∑–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      - name: üîé  Print environment
        script: |
          echo "CI user      : $(whoami)"
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Xcode path   : $(xcode-select -p)"
          echo "Team ID      : 74YTNA35A3"
          echo "Project      : $XCODE_PROJECT"
          echo "Scheme       : $XCODE_SCHEME"

      # 1.  –ö–∞–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Ä–µ–∞–ª—å–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ keychain
      - name: üîé  List certificates
        script: |
          echo "Certificates in Codemagic keychain:"
          keychain list-certificates || true

          echo "Security identities:"
          security find-identity -v -p codesigning || true

      # 2.  –ö–∞–∫–∏–µ provisioning‚Äëprofile —Å–∫–∞—á–∞–ª Codemagic
      - name: üîé  List profiles
        script: |
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "Profiles at $PROFILE_DIR :"
          ls -l "$PROFILE_DIR" || true

          # –≤—ã–≤–æ–¥–∏–º BundleID, TeamID, Capabilities –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
          for f in "$PROFILE_DIR"/*.mobileprovision; do
            [ -e "$f" ] || continue
            echo "----- $(basename "$f") ------------------------------------"
            /usr/bin/security cms -D -i "$f" \
              | /usr/bin/plutil -extract Name xml1 -o - - \
              | xmllint --xpath "string(//string)" - 2>/dev/null
            /usr/bin/security cms -D -i "$f" \
              | /usr/bin/plutil -extract Entitlements xml1 -o - - \
              | xmllint --xpath "//dict/key" - 2>/dev/null | tr '\n' ' '
            echo; echo
          done

      # 3.  –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –≤–∏–¥–∏—Ç —Ç–µ –∂–µ BundleID/SigningStyle
      - name: üîé  Show build settings
        script: |
          xcodebuild -project "$XCODE_PROJECT" \
                     -scheme "$XCODE_SCHEME" \
                     -showBuildSettings | egrep "DEVELOPMENT_TEAM|PRODUCT_BUNDLE_IDENTIFIER|CODE_SIGN_STYLE"

      # 4.  –°–±–æ—Ä–∫–∞ (–±–µ–∑ —è–≤–Ω—ã—Ö override ‚Äë¬†–ø—É—Å—Ç—å Xcode —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å)
      - name: Archive & export
        script: |
          set -e
          xcodebuild -project "$XCODE_PROJECT" \
                     -scheme  "$XCODE_SCHEME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -allowProvisioningUpdates \
                     clean archive

          # 4.1  –ò–∑–≤–ª–µ–∫–∞–µ–º embedded.mobileprovision –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
          APP_PATH="$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive/Products/Applications/$XCODE_SCHEME.app"
          if [[ -f "$APP_PATH/embedded.mobileprovision" ]]; then
            echo "üîé  embedded.mobileprovision inside .app:"
            /usr/bin/security cms -D -i "$APP_PATH/embedded.mobileprovision" \
              | /usr/bin/plutil -extract Name xml1 -o - - \
              | xmllint --xpath "string(//string)" -
            echo
          else
            echo "‚ö†Ô∏è  embedded.mobileprovision is missing in app bundle"
          fi

          # 4.2  –≠–∫—Å–ø–æ—Ä—Ç IPA
          xcodebuild -exportArchive \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -exportOptionsPlist ExportOptions.plist \
                     -allowProvisioningUpdates \
                     -exportPath "$CM_EXPORT_DIR"

    artifacts:
      - "$CM_EXPORT_DIR/*.ipa"

    publishing:
      app_store_connect:
        api_key:   $APP_STORE_CONNECT_PRIVATE_KEY
        key_id:    $APP_STORE_CONNECT_KEY_ID
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: false
        submit_to_app_store:  false

# –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ Codemagic –¥–æ–ª–∂–µ–Ω —Å–∫–∞—á–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
code_signing:
  certificates:
    - certificate: Hidden                     # Apple Distribution p12
      password:   $CERT_PASSWORD
  provisioning_profiles:
    - profile: HiddenProfile                  # .mobileprovision c Wi‚ÄëFi capability
      bundle_id: dev.legacy.HiddenCameraDetector
