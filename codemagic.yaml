workflows:
  ios-app-store:
    name: Upload build to ASC

    integrations:
      app_store_connect: "CodeMagic API"

    environment:
      xcode: 16.3
      groups: [appstore_credentials]          # API key + CERT_PASSWORD
      vars:
        XCODE_PROJECT: "HiddenCameraDetector.xcodeproj"
        XCODE_SCHEME:  "HiddenCameraDetector"
      ios_signing:                            # üëâ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ
        distribution_type: app_store
        bundle_identifier: dev.legacy.HiddenCameraDetector

    scripts:
      - name: Archive & export
        script: |
          set -e
          xcodebuild -project "$XCODE_PROJECT" \
                     -scheme  "$XCODE_SCHEME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -allowProvisioningUpdates \
                     clean archive

          xcodebuild -exportArchive \
                     -archivePath "$CM_BUILD_DIR/$XCODE_SCHEME.xcarchive" \
                     -exportOptionsPlist ExportOptions.plist \
                     -allowProvisioningUpdates \
                     -exportPath "$CM_EXPORT_DIR"

    artifacts:
      - "$CM_EXPORT_DIR/*.ipa"

    publishing:
      app_store_connect:
        api_key:   $APP_STORE_CONNECT_PRIVATE_KEY
        key_id:    $APP_STORE_CONNECT_KEY_ID
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: false
        submit_to_app_store:  false

# ‚¨áÔ∏è  –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û ‚Äî –∏–º–µ–Ω–Ω–æ –æ—Ç—Å—é–¥–∞ Codemagic –∑–∞–±–∏—Ä–∞–µ—Ç p12 –∏ –ø—Ä–æ—Ñ–∏–ª—å
code_signing:
  certificates:
    - certificate: Hidden          # reference‚Äëname p12 –≤ UI
      password:   $CERT_PASSWORD   # –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –≥—Ä—É–ø–ø–µ appstore_credentials
  provisioning_profiles:
    - profile: HiddenProfile       # reference‚Äëname .mobileprovision
      bundle_id: dev.legacy.HiddenCameraDetector
